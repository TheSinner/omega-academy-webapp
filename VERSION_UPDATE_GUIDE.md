# 🔄 버전 업데이트 가이드

## 📌 문제 해결: 캐시 때문에 새 버전이 안 보여요!

이제 이 문제가 해결되었습니다! 하지만 **배포할 때마다 버전 번호를 변경**해야 합니다.

---

## ✅ 해결된 것들

### 1. 자동 캐시 무효화
- ✅ HTML에 `Cache-Control` 헤더 추가
- ✅ 모든 JS/CSS 파일에 버전 쿼리 파라미터 추가
- ✅ Service Worker 버전 관리 시스템

### 2. 자동 업데이트 알림
- ✅ 새 버전 감지 시 사용자에게 확인 메시지
- ✅ 확인 시 자동 새로고침
- ✅ Service Worker 즉시 활성화

### 3. 스마트 캐싱 전략
- ✅ HTML: 항상 최신 버전 (Network First)
- ✅ API: 캐시 안함 (Always Network)
- ✅ 정적 파일: Stale-While-Revalidate (빠른 로딩 + 백그라운드 업데이트)

---

## 🚀 배포 시 해야 할 일 (중요!)

### 📝 버전 번호 변경 (2곳)

매번 배포 전에 **반드시** 다음 2개 파일의 버전 번호를 올려야 합니다:

#### 1️⃣ `src/index.tsx` (7번째 줄)
```typescript
// 이전
const APP_VERSION = '1.1.1';

// 다음 배포 시
const APP_VERSION = '1.1.2';  // ← 마지막 숫자를 1 증가
```

#### 2️⃣ `public/sw.js` (3번째 줄)
```javascript
// 이전
const CACHE_VERSION = '1.1.1';

// 다음 배포 시
const CACHE_VERSION = '1.1.2';  // ← 같은 버전으로 맞춤
```

**⚠️ 주의:** 두 파일의 버전이 반드시 **같아야** 합니다!

---

## 📋 전체 배포 프로세스

```powershell
# 1. 코드 수정 (기능 추가, 버그 수정 등)
# ...

# 2. 버전 번호 변경
# src/index.tsx의 APP_VERSION 변경
# public/sw.js의 CACHE_VERSION 변경 (같은 번호로!)

# 3. 빌드
npm run build

# 4. 배포
npx wrangler pages deploy dist --project-name omega-academy

# 5. 완료!
# 사용자가 접속하면 자동으로 새 버전 감지 및 업데이트
```

---

## 🎯 버전 번호 규칙

### Semantic Versioning 권장

```
MAJOR.MINOR.PATCH
  1  .  1  .  1
```

- **MAJOR (1.x.x)**: 큰 변경사항, 호환성 깨지는 변경
  - 예: 전체 UI 리뉴얼, 데이터베이스 구조 변경
  
- **MINOR (x.1.x)**: 새 기능 추가 (호환성 유지)
  - 예: 새 페이지 추가, 새 API 엔드포인트 추가
  
- **PATCH (x.x.1)**: 버그 수정, 작은 개선
  - 예: 텍스트 수정, 스타일 조정, 버그 수정

### 예시

```
1.1.1 → 1.1.2  (버그 수정)
1.1.2 → 1.2.0  (새 기능 추가)
1.2.0 → 2.0.0  (대규모 변경)
```

---

## 🔍 사용자가 보는 것

### 배포 후 첫 방문 시:

1. **페이지 로드**
   ```
   ✓ 최신 HTML 다운로드
   ✓ 새 버전 감지
   ✓ Service Worker 업데이트 시작
   ```

2. **업데이트 알림 (자동)**
   ```
   🔔 "새 버전이 있습니다. 페이지를 새로고침 하시겠습니까?"
   
   [확인] [취소]
   ```

3. **확인 클릭 시**
   ```
   ✓ 페이지 자동 새로고침
   ✓ 최신 버전으로 업데이트 완료!
   ```

---

## 🛠️ 문제 해결

### Q: 버전을 올렸는데도 캐시가 안 지워져요

**A:** 다음을 확인하세요:

1. **두 파일의 버전이 같은지 확인**
   ```bash
   # src/index.tsx의 APP_VERSION
   grep APP_VERSION src/index.tsx
   
   # public/sw.js의 CACHE_VERSION
   grep CACHE_VERSION public/sw.js
   ```

2. **빌드를 다시 했는지 확인**
   ```powershell
   npm run build
   ```

3. **브라우저 개발자 도구 확인**
   ```
   F12 → Application → Service Workers
   → "Update on reload" 체크
   → 새로고침
   ```

### Q: 사용자가 업데이트 알림을 무시하면?

**A:** 괜찮습니다!
- 다음 방문 시 다시 알림이 표시됩니다
- 백그라운드에서 자동으로 업데이트됩니다
- 최악의 경우 하드 새로고침 (Ctrl+Shift+R)으로 해결 가능

### Q: 개발 중에는 어떻게 하나요?

**A:** 개발 중에는 버전 변경 불필요
- 브라우저 개발자 도구에서 "Disable cache" 사용
- 또는 시크릿 모드 사용
- PM2 재시작 시 자동으로 최신 코드 반영

---

## 📊 버전 히스토리 예시

| 버전 | 날짜 | 변경사항 |
|------|------|----------|
| 1.0.0 | 2025-10-26 | 최초 배포 |
| 1.1.0 | 2025-10-28 | PWA 설치 기능 개선 |
| 1.1.1 | 2025-10-28 | 앱 아이콘 업데이트 |
| 1.1.2 | 2025-10-28 | 캐시 무효화 시스템 추가 |

---

## 🎓 요약

### 배포 전 체크리스트

- [ ] 코드 수정 완료
- [ ] `src/index.tsx`의 `APP_VERSION` 변경
- [ ] `public/sw.js`의 `CACHE_VERSION` 변경 (같은 번호!)
- [ ] `npm run build` 실행
- [ ] `npx wrangler pages deploy dist` 실행
- [ ] 프로덕션 URL 접속 및 테스트

### 이제는:
✅ 캐시 삭제 불필요!
✅ 자동 업데이트 알림!
✅ 버전 관리 체계화!

---

**마지막 수정:** 2025-10-28  
**현재 버전:** 1.1.2
